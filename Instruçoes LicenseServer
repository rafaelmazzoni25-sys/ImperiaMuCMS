# Guia completo do License Server do ImperiaMuCMS

Este documento foi escrito para quem **nunca mexeu** com servidores de licen√ßa. Siga as etapas
na ordem e marque cada item realizado. Se algo der errado, procure a se√ß√£o de
"Solu√ß√£o de problemas" ao final.

---

## 1. Entendendo o que √© o License Server

* O ImperiaMuCMS utiliza "chaves" para liberar os m√≥dulos premium.
* O **License Server** funciona como um porteiro: ele recebe os pedidos do CMS e
  responde se o site possui autoriza√ß√£o.
* Ele √© um programa para Windows com uma janela simples e um servidor interno
  que responde na porta HTTP que voc√™ escolher (ex.: `http://127.0.0.1:5000/`).
* Para que o site funcione com m√≥dulos pagos, o License Server precisa estar
  **sempre aberto** ou configurado para iniciar junto com o computador.

---

## 2. O que voc√™ precisa antes de come√ßar

| Item | O que fazer |
|------|-------------|
| Computador | Windows 10 ou 11 com acesso de administrador. |
| Espa√ßo em disco | Pelo menos 500 MB livres para instalar as ferramentas. |
| Internet | Necess√°ria para baixar o .NET e o Visual Studio. |
| Ferramentas | Voc√™ pode escolher **uma** das op√ß√µes abaixo: <br> ‚Ä¢ Visual Studio 2022 (edi√ß√£o Community gratuita) com a carga de trabalho ‚ÄúDesktop development with .NET‚Äù. <br> ‚Ä¢ Apenas o **.NET SDK 6.0 ou superior**, se preferir usar o PowerShell ou Prompt de Comando. |
| Permiss√µes de rede | Autorizar a porta do License Server no Firewall do Windows. Se a porta for negada, use o comando `netsh http add urlacl url=http://*:5000/ user=SEUUSUARIO` em um Prompt de Comando **como administrador**. |

> üí° **Dica:** se n√£o sabe qual porta utilizar, mantenha `5000`. Caso o computador
> j√° utilize essa porta, escolha outra (por exemplo `5001`).

---

## 3. Baixando os arquivos do projeto

1. Baixe ou clone o pacote do ImperiaMuCMS no seu computador.
2. Dentro da pasta principal, abra `tools/license-server`. Nela voc√™ encontrar√°:
   ```
   LicenseServer.sln          -> Projeto para o Visual Studio
   LicenseServer.csproj       -> Arquivo principal do projeto .NET
   license-config.json        -> Arquivo com as licen√ßas salvas
   README.md                  -> Refer√™ncia t√©cnica (em ingl√™s)
   ```
3. Fa√ßa uma **c√≥pia de seguran√ßa** do arquivo `license-config.json`. Guarde-a em
   um local seguro (por exemplo, uma pasta "Backup" na √Årea de Trabalho).

---

## 4. Instalando as ferramentas

### Op√ß√£o A ‚Äì Usando o Visual Studio 2022
1. Acesse <https://visualstudio.microsoft.com/pt-br/> e clique em **Download**.
2. Abra o instalador e marque a carga de trabalho **Desenvolvimento de √°rea de trabalho com .NET**.
3. Conclua a instala√ß√£o (pode demorar alguns minutos).

### Op√ß√£o B ‚Äì Usando apenas o .NET SDK
1. Entre em <https://dotnet.microsoft.com/download>.
2. Fa√ßa o download do instalador do **.NET SDK 6.0 para Windows x64**.
3. Execute o instalador e finalize o processo.

Voc√™ pode instalar as duas ferramentas se quiser, mas n√£o √© obrigat√≥rio.

---

## 5. Abrindo o projeto pela primeira vez

### Visual Studio
1. Abra o Visual Studio.
2. Clique em **Abrir um projeto ou solu√ß√£o** e selecione `LicenseServer.sln`.
3. Aguarde o carregamento at√© que a barra inferior mostre ‚ÄúPronto‚Äù.
4. Pressione **Ctrl + Shift + B** para compilar. O execut√°vel ser√° gerado em
   `tools/license-server/bin/Debug/net6.0-windows/LicenseServer.exe`.
5. Pressione **F5** para iniciar o programa (se perguntar sobre permiss√µes de
   firewall, autorize).

### Linha de comando (PowerShell ou Prompt)
1. Abra o **PowerShell** ou **Prompt de Comando do Desenvolvedor**.
2. V√° at√© a pasta do projeto:
   ```powershell
   cd C:\caminho\at√©\ImperiaMuCMS
   ```
3. Execute a compila√ß√£o:
   ```powershell
   dotnet build tools/license-server/LicenseServer.csproj
   ```
4. Inicie o License Server diretamente:
   ```powershell
   dotnet run --project tools/license-server/LicenseServer.csproj
   ```
5. Para distribuir para outro computador, gere uma pasta de publica√ß√£o:
   ```powershell
   dotnet publish tools/license-server/LicenseServer.csproj -c Release -r win-x64 --self-contained false
   ```
   Copie o conte√∫do da pasta `publish` para o computador desejado.

---

## 6. Conhecendo a janela do License Server

Quando o programa abre, a tela principal possui quatro abas:

1. **Usu√°rios** ‚Äì onde voc√™ cadastra cada cliente/site.
2. **M√≥dulos** ‚Äì lista de m√≥dulos premium (Bug Tracker, Vip, etc.).
3. **Servidor** ‚Äì configura a porta que ser√° usada e os dom√≠nios padr√£o.
4. **Logs** ‚Äì mostra as mensagens de funcionamento e poss√≠veis erros.

No topo existe o menu **Arquivo**, que permite abrir outro arquivo de
configura√ß√£o e salvar altera√ß√µes manualmente.

> üîê **Aten√ß√£o:** qualquer altera√ß√£o s√≥ √© gravada depois que voc√™ clica no bot√£o
> **Salvar**. Fa√ßa isso sempre que mudar algo.

---

## 7. Preparando o arquivo `license-config.json`

1. Com o programa aberto, clique em **Arquivo ‚ûú Abrir configura√ß√£o**.
2. Escolha `license-config.json` (ou outro arquivo que queira usar).
3. Ao abrir, verifique os campos principais:
   * **HTTP Prefixes**: endere√ßo onde o programa escuta. Ex.: `http://*:5000/`.
   * **Default Custom Fields**: dom√≠nios ou IPs padr√£o autorizados (ex.: `localhost`, `127.0.0.1`).
   * **Lista de M√≥dulos**: defina os m√≥dulos dispon√≠veis. Cada m√≥dulo possui `ID` e `Nome`.

Se quiser manter ambientes separados (teste e produ√ß√£o), salve c√≥pias com nomes
como `license-config-prod.json` e `license-config-dev.json`. Abra o arquivo correto
antes de trabalhar em cada ambiente.

---

## 8. Cadastrando um cliente (site) passo a passo

1. Na aba **Usu√°rios**, clique em **Adicionar**.
2. Preencha os campos do bloco **Licen√ßa Principal**:
   * **Name (Nome)**: apelido para identificar o cliente. Ex.: `Site Principal`.
   * **Identifier (Identificador)**: e-mail ou c√≥digo √∫nico. Ex.: `site@imperiamu`.
   * **Usage ID**: nome interno que o CMS usar√°. Ex.: `core`.
   * **License Key (Chave)**: c√≥digo secreto (pode inventar algo como `CORE-123`).
   * **Status**: escolha **Active** para liberar o acesso.
   * **Expiration Date**: data limite. Use uma data futura ou deixe vazio para n√£o expirar.
3. Clique em **Salvar** para guardar as mudan√ßas.

### Associando m√≥dulos premium
1. Ainda na aba **Usu√°rios**, selecione o cliente criado.
2. Na tabela de m√≥dulos, marque aqueles que o cliente deve ter.
3. Para cada m√≥dulo marcado, informe:
   * **Usage ID** ‚Äì pode ser algo simples como `vip`.
   * **License Key** ‚Äì crie uma chave √∫nica, por exemplo `VIP-999`.
   * **Status** ‚Äì deixe como **Active**.
   * **Expiration** ‚Äì defina uma data ou deixe em branco.
   * **Custom Fields** ‚Äì coloque os dom√≠nios ou IPs autorizados (ex.: `mu.local`).
4. Clique novamente em **Salvar**.

> ‚úÖ **Resultado esperado:** o cliente aparecer√° na lista e o log mostrar√°
> `Configuration saved successfully.`

---

## 9. Configurando a aba Servidor

1. Abra a aba **Servidor**.
2. Em **HTTP Prefixes**, mantenha `http://*:5000/` ou troque pela porta desejada.
3. Em **Default Custom Fields**, mantenha os dom√≠nios/IPs que sempre ter√£o acesso.
4. Clique em **Salvar**. O servidor interno ser√° reiniciado com a nova porta.
5. Observe a aba **Logs**: deve aparecer a mensagem `HTTP listener started`.

Se o log mostrar erro de permiss√£o, abra o programa novamente como **Administrador**.

---

## 10. Ligando o License Server ao ImperiaMuCMS

1. No computador onde o CMS est√° instalado, abra o arquivo
   `includes/imperiamucms.php` em um editor de texto (Notepad++ ou similar).
2. Procure pela linha com `define('__IMPERIAMUCMS_LICENSE_SERVER__', ...)`.
3. Substitua o endere√ßo pela URL do License Server. Exemplo:
   ```php
   define('__IMPERIAMUCMS_LICENSE_SERVER__', 'http://192.168.0.5:5000/');
   ```
4. Salve o arquivo.
5. Certifique-se de que os arquivos de licen√ßa existem na pasta
   `includes/license/`:
   * `license.imperiamucms` (n√∫cleo do CMS).
   * `license_<modulo>.imperiamucms` (um arquivo para cada m√≥dulo premium).
6. Se os arquivos n√£o existirem ou estiverem vazios, gere-os seguindo a pr√≥xima se√ß√£o.

---

## 11. Gerando os arquivos de licen√ßa criptografados

1. Com o License Server aberto, confirme o **Identifier** e o **Usage ID** do
   cliente e do m√≥dulo desejado.
2. No navegador, digite:
   ```
   http://ENDERECO:PORTA/applications/nexus/interface/licenses/?info&key=CHAVE&identifier=IDENTIFIER&usage_id=USAGEID
   ```
   * Substitua `ENDERECO:PORTA` pelo endere√ßo configurado (ex.: `127.0.0.1:5000`).
   * Use a `CHAVE`, o `IDENTIFIER` e o `USAGEID` exatamente como cadastrados (para m√≥dulos, utilize os valores espec√≠ficos de cada item).
3. (Opcional) Para validar o status antes de salvar, chame tamb√©m `.../?check&key=CHAVE&identifier=IDENTIFIER&usage_id=USAGEID`; o texto retornado deve conter `status":"ACTIVE"` ap√≥s a descriptografia autom√°tica feita pelo CMS.
4. O navegador exibir√° um texto com v√°rios caracteres (JSON criptografado).
5. Copie todo o conte√∫do (Ctrl + A, depois Ctrl + C) e cole em um arquivo novo:
   * N√∫cleo: `includes/license/license.imperiamucms`.
   * M√≥dulo: `includes/license/license_nome-do-modulo.imperiamucms`.
6. Salve o arquivo e limpe a pasta `includes/cache` do CMS (apague os arquivos tempor√°rios).
7. Acesse o site. Se tudo estiver certo, as mensagens de erro 601‚Äì707 desaparecem
   e os m√≥dulos ficam dispon√≠veis.

> üõ°Ô∏è **Seguran√ßa:** mantenha esses arquivos longe de terceiros. Eles liberam o
> acesso aos seus m√≥dulos premium.

---

## 12. Testes r√°pidos ap√≥s a configura√ß√£o

| Teste | Como realizar | Resultado esperado |
|-------|---------------|--------------------|
| Verificar se o servidor est√° respondendo | No navegador, acesse `http://ENDERECO:PORTA/apiversion.php`. | A p√°gina deve retornar `1` e o log indicar que o listener est√° ativo. |
| Testar um cliente espec√≠fico | Acesse `http://ENDERECO:PORTA/applications/nexus/interface/licenses/?check&key=...&identifier=...&usage_id=...`. | Resposta cifrada (sem erro 404) e registro `Verifica√ß√£o de licen√ßa aprovada` na aba **Logs**. |
| Conferir o CMS | Abra a √°rea administrativa do ImperiaMuCMS. | Nenhum alerta de licen√ßa; m√≥dulos premium ativos. |

Se algum passo falhar, volte √†s se√ß√µes anteriores e confirme cada campo.

---

## 13. Mantendo o License Server sempre ativo

* **Iniciar junto com o Windows**: pressione `Win + R`, digite `shell:startup` e
  pressione Enter. Cole um atalho do `LicenseServer.exe` nessa pasta.
* **Executar como servi√ßo** (opcional): depois de publicar o projeto, utilize uma
  ferramenta como **NSSM** para instalar o execut√°vel como servi√ßo do Windows.
* **Logs externos**: se quiser hist√≥rico mais longo, habilite o registro do
  Windows (Visualizador de Eventos) ou salve os logs em arquivos usando o pr√≥prio
  programa.

---

## 14. Fazendo backup das licen√ßas

1. Feche o License Server para evitar que o arquivo seja sobrescrito.
2. Copie `license-config.json` e cole em um local seguro (HD externo, nuvem, etc.).
3. Renomeie a c√≥pia com a data, por exemplo `license-config-2024-05-10.json`.
4. Caso precise restaurar, basta substituir o arquivo original pela c√≥pia e
   abrir novamente no programa.

---

## 15. Solu√ß√£o de problemas comuns

| Problema | Causa prov√°vel | Como resolver |
|----------|----------------|----------------|
| Mensagem "Access is denied" ao iniciar | Falta de permiss√£o para reservar a porta. | Execute o programa como administrador ou rode `netsh http add urlacl url=http://*:PORTA/ user=SEUUSUARIO` (trocando PORTA pelo n√∫mero utilizado). |
| Porta ocupada | Outro programa j√° usa a mesma porta. | Troque a porta em **HTTP Prefixes** (ex.: 5001) e salve. |
| CMS informa que a licen√ßa √© inv√°lida | Dados diferentes entre o CMS e o License Server. | Confirme `Identifier`, `Usage ID`, `License Key`, `Status` e `Custom Fields`. Gere os arquivos de licen√ßa novamente. |
| Resposta demora ou n√£o chega | Firewall bloqueando ou IP errado. | Libere a porta no Firewall do Windows e verifique se o endere√ßo configurado est√° correto. |
| Arquivo `license-config.json` corrompeu | Desligamento for√ßado durante salvamento. | Feche o programa, restaure o backup mais recente e abra novamente. |

---

## 16. Gloss√°rio r√°pido

| Termo | Significado simples |
|-------|---------------------|
| **Identifier** | C√≥digo que representa o cliente ou site. |
| **Usage ID** | Nome interno usado pelo sistema para cada licen√ßa. |
| **License Key** | Senha secreta que valida o uso. |
| **Custom Fields** | Lista de dom√≠nios ou IPs autorizados. |
| **HTTP Prefix** | Endere√ßo onde o License Server escuta os pedidos do CMS. |
| **HTTP Listener** | Servi√ßo interno que responde √†s solicita√ß√µes do CMS. |
| **JSON** | Formato de arquivo de texto usado para guardar as configura√ß√µes. |

---

## 17. Checklist final

- [ ] Instalei o Visual Studio ou o .NET SDK 6.0.
- [ ] Consegui abrir e compilar o projeto `LicenseServer`.
- [ ] Cadastrei pelo menos um cliente com m√≥dulos ativos.
- [ ] Configurei os `HTTP Prefixes` e liberei a porta no firewall.
- [ ] Atualizei a constante `__IMPERIAMUCMS_LICENSE_SERVER__` no CMS.
- [ ] Gerei os arquivos de licen√ßa e copiei para `includes/license/`.
- [ ] Testei o acesso ao site e os m√≥dulos premium est√£o funcionando.
- [ ] Fiz backup do `license-config.json` atualizado.

Seguindo este guia voc√™ ter√° o License Server pronto para validar as licen√ßas do
ImperiaMuCMS de forma segura, mesmo sem experi√™ncia t√©cnica pr√©via.
